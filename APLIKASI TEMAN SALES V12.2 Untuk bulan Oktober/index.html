<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teman Sales - Kalkulator Order</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <script src="data.js"></script>

    <style>
        :root {
            --primary-color: #d32f2f; --secondary-color: #f44336; --background-color: #f5f5f5;
            --surface-color: #ffffff; --text-color: #212121; --text-light-color: #757575;
            --border-color: #e0e0e0; --accent-color: #ffc107; --success-color: #4caf50;
            --info-color: #1e88e5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--surface-color); box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; min-height: 100vh; }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .header-title { display: flex; align-items: center; gap: 1rem; }
        .header-title img { height: 60px; }
        header h1 { margin: 0; font-size: 1.5rem; }
        .tabs { display: flex; background-color: var(--secondary-color); flex-wrap: wrap; }
        .tab-button { padding: 1rem 1.5rem; cursor: pointer; border: none; background-color: transparent; color: white; font-size: 1rem; font-weight: 500; opacity: 0.8; transition: opacity 0.2s, background-color 0.2s; flex-grow: 1; text-align: center; }
        .tab-button.active { opacity: 1; background-color: var(--primary-color); border-bottom: 3px solid var(--accent-color); }
        .content { padding: 1.5rem; padding-bottom: 100px; }
        .page { display: none; }
        .page.active { display: block; }
        .group-container { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: 8px; }
        .group-header { padding: 0.75rem 1rem; font-weight: bold; }
        .group-wafer-flat-non-2k { background-color: #e3f2fd; border-left: 5px solid #2196f3; } 
        .group-biscuit { background-color: #e8f5e9; border-left: 5px solid #4caf50; } 
        .group-snack { background-color: #fffde7; border-left: 5px solid #ffc107; } 
        .group-confect { background-color: #f3e5f5; border-left: 5px solid #9c27b0; } 
        .group-npl { background-color: #e0f7fa; border-left: 5px solid #00bcd4; } 
        .group-wafer-2k { background-color: #f1f8e9; border-left: 5px solid #8bc34a; } 
        .group-chocopie { background-color: #fff3e0; border-left: 5px solid #ff9800; } 
        .group-beverage { background-color: #e1f5fe; border-left: 5px solid #03a9f4; } 
        .group-simba { background-color: #fbe9e7; border-left: 5px solid #ff5722; } 
        .group-simba-2-in-1 { background-color: #ede7f6; border-left: 5px solid #673ab7; } 
        .group-hello-panda { background-color: #fce4ec; border-left: 5px solid #e91e63; }
        .group-biscuit-non-2k { background-color: #fff3e0; border-left: 5px solid #ff9800; }
        .group-simba-bulky { background-color: #e8eaf6; border-left: 5px solid #3f51b5; }
		.group-csd-2k-12-pcs { background-color: #e0f2f1; border-left: 5px solid #009688; }
        .group-csd-2k-24-pcs { background-color: #e0f2f1; border-left: 5px solid #009688; }
        
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .product-table, .loyalty-table { width: 100%; border-collapse: collapse; }
        .product-table th, .product-table td, .loyalty-table th, .loyalty-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; white-space: nowrap; }
        .product-table tr:last-child td { border-bottom: none; }
        .product-table th, .loyalty-table th { font-size: 0.85rem; color: var(--text-light-color); }
        .loyalty-table td { font-size: 0.9rem; }
        .loyalty-table th, .loyalty-table td { text-align: center; }
        .loyalty-table td:first-child, .loyalty-table th:first-child, .loyalty-table td:nth-child(2), .loyalty-table th:nth-child(2) { text-align: left; }
        .quantity-input { display: flex; align-items: center; gap: 0; }
        .quantity-input input { width: 60px; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; }
        .quantity-input button { border: 1px solid var(--border-color); background-color: #f0f0f0; }
        .product-name { font-weight: 500; }
        .product-meta { font-size: 0.8rem; color: var(--text-light-color); }
        .summary { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--surface-color); border-top: 2px solid var(--primary-color); box-shadow: 0 -4px 6px rgba(0,0,0,0.05); z-index: 100; transition: max-height 0.3s ease-in-out; max-height: 80px; overflow: hidden; }
        .summary.expanded { max-height: 90vh; }
        .summary-content { max-width: 1200px; margin: 0 auto; position: relative; }
        .summary-collapsed-view { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1.5rem; height: 80px; box-sizing: border-box; cursor: pointer; }
        .summary-collapsed-view .summary-label { margin: 0; font-size: 0.9rem; color: var(--text-light-color); }
        .summary-collapsed-view .summary-value.total { font-size: 1.75rem; color: var(--primary-color); }
        .summary-expanded-view { padding: 1rem 1.5rem; max-height: calc(90vh - 80px); overflow-y: auto; }
        .summary-toggle-btn { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; color: var(--text-light-color); }
        .summary.expanded .summary-toggle-btn .arrow-up { display: none; }
        .summary:not(.expanded) .summary-toggle-btn .arrow-down { display: none; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .summary-item { padding: 0.5rem; }
        .summary-value { font-size: 1.25rem; font-weight: bold; }
        .summary-breakdown { font-size: 0.8rem; color: var(--success-color); }
        .order-actions { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .order-actions input[type="text"] { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; }
        .order-actions button { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .promo-gallery-style { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        #promo-gallery img, #catalog-gallery img { width: 100%; max-width: 100%; height: auto; display: block; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        #promo-gallery img:hover, #catalog-gallery img:hover { transform: scale(1.03); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        #loyalty-calculator-form { margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        #loyalty-result { margin-top: 1.5rem; padding: 1.5rem; border-radius: 8px; background-color: #e8f5e9; border: 1px solid var(--success-color); display: none; max-width: 700px; margin-left: auto; margin-right: auto; }
        #loyalty-result h4 { margin-top: 0; color: var(--success-color); text-align: center; }
        #loyalty-result p { margin: 0.5rem 0; font-size: 1.1rem; }
        #loyalty-result .result-value { font-weight: bold; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--primary-color); }
        #login-box { background-color: white; padding: 2.5rem; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px; }
        #login-box h2 { margin-top: 0; color: var(--primary-color); }
        #login-box input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        #login-box button { width: 100%; padding: 0.75rem; border: none; border-radius: 4px; background-color: var(--primary-color); color: white; font-size: 1rem; font-weight: bold; cursor: pointer; }
        #login-error { color: var(--primary-color); margin-top: 1rem; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; max-width: 90%; width: 700px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; }
        .modal-close { font-size: 1.5rem; cursor: pointer; border: none; background: none; }
        .info-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .info-table th, .info-table td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .history-actions button { padding: 0.4rem 0.8rem; margin: 0.2rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .detail-btn { border: 1px solid var(--info-color); color: var(--info-color); background-color: white; }
        .edit-btn { border: 1px solid #43a047; color: #43a047; background-color: white; }
        .delete-btn { border: 1px solid var(--primary-color); color: var(--primary-color); background-color: white; }
        .export-btn { border: 1px solid #1D6F42; color: #1D6F42; background-color: white; }
        .upsell-outer-container { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: none; }
        .upsell-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .upsell-item { padding: 1rem; border-radius: 8px; border: 1px solid; font-size: 0.9rem; line-height: 1.5; }
        .upsell-item.goal { background-color: #fffde7; border-color: var(--accent-color); color: #5d4037; }
        .upsell-item.achieved { background-color: #e8f5e9; border-color: var(--success-color); color: #1b5e20; }
        .upsell-item strong { font-weight: bold; }
        .upsell-item.goal strong { color: var(--text-color); }
        .upsell-item.achieved strong { color: #1b5e20; }
        .logout-btn { background-color: var(--secondary-color); color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background-color 0.2s, border-color 0.2s; }
        .logout-btn:hover, .logout-btn:focus { background-color: white; color: var(--primary-color); border-color: var(--primary-color); }
        .image-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 300; display: none; justify-content: center; align-items: center; padding: 1rem; box-sizing: border-box; }
        .image-modal-content { position: relative; max-width: 95%; max-height: 90vh; }
        .image-modal-content img { width: auto; height: auto; max-width: 100%; max-height: 90vh; display: block; border-radius: 8px; }
        .image-modal-close { position: absolute; top: -15px; right: -15px; color: white; background-color: var(--primary-color); border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; font-weight: bold; border: 2px solid white; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
        #search-container { margin-bottom: 1.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; }
        #clear-search-btn { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-light-color); font-size: 1.5rem; font-weight: bold; display: none; }
        #fokus-alokasi-container { display: none; margin-top: 8px; }
        #voucher-fokus-list { max-height: 100px; overflow-y: auto; border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 4px; }
        #voucher-fokus-list div { margin-bottom: 4px; display: flex; align-items: center; }
        #voucher-fokus-list label { cursor: pointer; }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .product-card-view { display: none; }
        .product-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; padding: 0.75rem; }
        .card-header .product-name { font-size: 1rem; }
        .card-header .product-meta { font-size: 0.75rem; }
        .card-body { border-top: 1px solid var(--border-color); margin-top: 0.75rem; padding-top: 0.75rem; }
        .input-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem; }
        .input-column label { display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; }
        .price-section { font-size: 0.85rem; color: var(--text-light-color); }
        .price-section .price-label { font-weight: 500; }
        .price-section span { color: var(--text-color); }
        .desktop-view .product-card-view { display: none; }
        .mobile-view .product-table-view { display: none; }
        .mobile-view .product-card-view { display: block; }
        @media (max-width: 768px) {
            .quantity-input input { width: 40px; padding: 0.4rem; font-size: 0.8rem; }
            .quantity-input button { width: 30px; padding: 0.4rem; font-size: 0.9rem; }
            header h1 { font-size: 1.2rem; }
            .tab-button { font-size: 0.8rem; padding: 0.8rem 0.5rem; }
        }
    </style>
</head>
<body>
    <div id="login-page">
        <div id="login-box">
            <h2>Teman Sales Login</h2>
            <p>Silakan masuk untuk mengakses kalkulator.</p>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleLogin()">Masuk</button>
            <p id="login-error">Username atau password salah.</p>
        </div>
    </div>
    
    <div id="app-container" style="display: none;">
        <div class="container">
            <header>
                <div class="header-title">
                    <img src="logo.png" alt="Logo Perusahaan">
                    <h1>Teman Sales</h1>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </header>
            <div class="tabs">
                <button class="tab-button active" onclick="showPage('kalkulator')">Kalkulator</button>
                <button class="tab-button" onclick="showPage('loyalty')">Loyalty</button>
                <button class="tab-button" onclick="showPage('katalog')">Katalog</button>
                <button class="tab-button" onclick="showPage('riwayat')">Riwayat Order</button>
                <button class="tab-button" onclick="showPage('diskon')">Info Diskon</button>
                <button class="tab-button" onclick="showPage('promo')">Info Promo</button>
            </div>
            
            <div id="kalkulator" class="content page active">
                <div id="search-container">
                    <input type="text" id="search-input" oninput="filterProducts()" placeholder="ðŸ” Cari nama produk...">
                    <span id="clear-search-btn" onclick="clearSearch()">&times;</span>
                </div>
                <div id="product-list"></div>
            </div>

            <div id="loyalty" class="content page">
                <h2>Insentif Loyalty</h2>
                <p>Gunakan halaman ini untuk melakukan simulasi perhitungan bonus insentif berdasarkan target omzet dan pencapaian mingguan.</p>

                <details style="margin-top: 2rem;">
                    <summary style="cursor: pointer; font-weight: bold; margin-bottom: 1rem; color: var(--primary-color);">
                        â–º Lihat Tabel Detail Insentif
                    </summary>
                    <div class="table-wrapper">
                        <table class="loyalty-table" id="loyalty-info-table">
                            <thead>
                                <tr>
                                    <th>Kelas</th>
                                    <th>Range Omzet (Rp)</th>
                                    <th>Capaian 4 Minggu</th>
                                    <th>Capaian 3 Minggu</th>
                                    <th>Capaian 2 Minggu</th>
                                    <th>Capaian 1 Minggu</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </details>

                <hr style="margin: 2rem 0;">

                <div id="loyalty-calculator-form">
                    <h3>Kalkulator Simulasi</h3>
                    <div class="form-group">
                        <label for="monthly-omzet-input">Omzet Bulanan Outlet (Rp)</label>
                        <input type="text" inputmode="numeric" id="monthly-omzet-input" placeholder="Contoh: 50000000">
                    </div>
                    <div class="form-group">
                        <label for="weekly-achievement-select">Pencapaian Target Mingguan</label>
                        <select id="weekly-achievement-select">
                            <option value="4" selected>4 Minggu</option>
                            <option value="3">3 Minggu</option>
                            <option value="2">2 Minggu</option>
                            <option value="1">1 Minggu</option>
                        </select>
                    </div>
                    <button onclick="calculateLoyalty()" style="width: 100%; padding: 0.8rem; font-size: 1.1rem; border: none; border-radius: 4px; background-color: var(--info-color); color: white; cursor: pointer;">Hitung Insentif Loyalty</button>
                </div>

                <div id="loyalty-result">
                    <h4>Hasil Simulasi</h4>
                    <p>Kelas Outlet: <span id="loyalty-result-kelas" class="result-value">-</span></p>
                    <p>Persentase Insentif: <span id="loyalty-result-persen" class="result-value">-</span></p>
                    <hr>
                    <p style="font-size: 1.3rem;"><b>Jumlah Nominal Voucher: <span id="loyalty-result-nominal" class="result-value">-</span></b></p>
                </div>
            </div>
            
            <div id="katalog" class="content page">
                <h2>Katalog Produk</h2>
                <div id="catalog-gallery" class="promo-gallery-style"></div>
            </div>

            <div id="riwayat" class="content page">
                <h2>Riwayat Order Disimpan</h2>
                <div class="table-wrapper">
                    <table class="info-table" id="history-table">
                        <thead><tr><th>ID Order</th><th>Toko</th><th>Tanggal</th><th>Total Nett</th><th>Aksi</th></tr></thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="diskon" class="content page">
                <h2>Daftar Aturan Diskon Aktif</h2>
                <div id="discount-list-container"></div>
            </div>

            <div id="promo" class="content page">
                <h2>Poster Promo Aktif</h2>
                <div id="promo-gallery" class="promo-gallery-style"></div>
            </div>

            <div style="text-align: center; padding: 2rem 1rem 1rem 1rem; font-size: 0.8rem; color: #bdbdbd;">
                Made in Garut, Swiss van Java. <br> 
                By Rifqi, With The Help of Garut Depo.
            </div>
        </div>

        <div class="summary" id="summary-footer">
            <div class="summary-content">
                <div class="summary-collapsed-view" onclick="toggleSummary()">
                    <div><div class="summary-label">Harga Nett</div><div class="summary-value total" id="summary-harga-nett-collapsed">Rp 0</div></div>
                    <button class="summary-toggle-btn"><span class="arrow-up">â–²</span><span class="arrow-down">â–¼</span></button>
                </div>
                <div class="summary-expanded-view">
                    <div class="summary-grid">
                        <div class="summary-item"><div class="summary-label">Total Harga Awal</div><div class="summary-value" id="summary-harga-awal">Rp 0</div></div>
                        <div class="summary-item"><div class="summary-label">Total Diskon</div><div class="summary-value" id="summary-total-diskon">Rp 0</div><div id="summary-diskon-breakdown" class="summary-breakdown"></div></div>
                        <div class="summary-item"><div class="summary-label">Harga Nett Final</div><div class="summary-value total" id="summary-harga-nett-expanded">Rp 0</div></div>
                        
                        <div class="summary-item">
                            <div class="summary-label">Diskon Voucher (Loyalty 4 Pekan)</div>
                            <select id="voucher-class-dropdown" class="quantity-input" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: white;">
                                <option value="0">Tanpa Voucher Loyalty</option>
                                </select>
                        </div>
                        <div class="summary-item"><div class="summary-label">Pembayaran & Opsi</div>
                            <div><label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="cod-checkbox" checked> COD</label></div>
                            <div><label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="promo-amo-checkbox" checked> Terapkan Promo AMO</label></div>
                            <div>
                                <label style="display: block; margin-bottom: 5px;">
                                    <input type="checkbox" id="voucher-alokasi-checkbox"> Alokasikan Voucher
                                </label>
                                <div id="fokus-alokasi-container">
                                    <label for="voucher-fokus-list" style="font-size:0.8rem; color: var(--text-light-color);">Fokus Alokasi ke:</label>
                                    <div id="voucher-fokus-list"></div>
                                </div>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Potongan Deal Khusus (Wafer 5K)</div>
                            <div class="quantity-input">
                                <input type="number" id="deal-khusus-input" placeholder="Rp 0" class="quantity-input" style="width:100%; padding:0.5rem; border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                <div style="padding: 0.5rem; border: 1px solid var(--border-color); border-left: 0; background-color: #eee; border-top-right-radius: 4px; border-bottom-right-radius: 4px;">
                                   <input type="checkbox" id="deal-khusus-checkbox" title="Aktifkan Deal Khusus">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="upsell-outer-container"><div id="upsell-grid" class="upsell-grid"></div></div>
                    <div class="order-actions">
                        <input type="text" id="toko-name-input" placeholder="Masukkan Nama Toko">
                        <button onclick="saveOrder()">Simpan Order</button>
                        <button onclick="showCurrentOrderDetail()" style="background-color: var(--info-color);">Detail Order</button>
                        <button onclick="resetOrder()" style="background-color: #757575;">Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="detail-modal" class="modal-overlay" onclick="closeDetailModal()"><div class="modal-content" onclick="event.stopPropagation()"><div class="modal-header"><h3 id="modal-title">Detail Order</h3><button class="modal-close" onclick="closeDetailModal()">&times;</button></div><div id="modal-body" style="margin-top: 1rem;"></div></div></div>
        <div id="image-modal" class="image-modal-overlay" onclick="closeImageModal()"><div class="image-modal-content" onclick="event.stopPropagation()"><img src="" id="modal-image-src" alt="Gambar Diperbesar"><button class="image-modal-close" onclick="closeImageModal()">&times;</button></div></div>
    </div>

    <script>
        const DRAFT_KEY = 'draft_order_pma';
        let currentOrder = {};
        let savedOrders = [];
        let editingOrderId = null;
        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(Math.round(value || 0));
        function sanitizeForCss(className) { return className.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, ''); }
        function saveDraft() {
            const hasUnsavedItems = Object.keys(currentOrder).some(key => (currentOrder[key].carton || 0) > 0 || (currentOrder[key].box || 0) > 0 || (currentOrder[key].stockCarton || 0) > 0 || (currentOrder[key].stockBox || 0) > 0);
            const tokoName = document.getElementById('toko-name-input').value;
            if (hasUnsavedItems || tokoName.trim() !== '') {
                const draft = {
                    order: currentOrder,
                    tokoName: tokoName,
                    voucherDiscount: document.getElementById('voucher-class-dropdown').value,
                    cod: document.getElementById('cod-checkbox').checked,
                    alokasiDiskon: document.getElementById('voucher-alokasi-checkbox').checked,
                    promoAmo: document.getElementById('promo-amo-checkbox').checked, // <-- PERUBAHAN 7A
                    dealKhususAktif: document.getElementById('deal-khusus-checkbox').checked,
                    dealKhususNominal: document.getElementById('deal-khusus-input').value,
                    fokusAlokasi: Array.from(document.querySelectorAll('.fokus-checkbox:checked')).map(cb => cb.value)
                };
                localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
            } else { localStorage.removeItem(DRAFT_KEY); }
        }
        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === '123' && pass === '123') {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initializeApp();
            } else { document.getElementById('login-error').style.display = 'block'; }
        }
        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                localStorage.removeItem(DRAFT_KEY);
                location.reload();
            }
        }
        function toggleSummary() { document.getElementById('summary-footer').classList.toggle('expanded'); }
        function loadSavedOrders() {
            try {
                const storageKey = (typeof config !== 'undefined' && config.STORAGE_KEY) ? config.STORAGE_KEY : 'pma_saved_orders';
                const savedData = localStorage.getItem(storageKey);
                if (savedData) { return JSON.parse(savedData); }
            } catch (error) { console.error("Gagal memuat data riwayat:", error); }
            return [];
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.value = '';
            document.getElementById('clear-search-btn').style.display = 'none';
            renderProducts(true);
            searchInput.focus();
        }

        function filterProducts() { 
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            if (clearBtn) {
                clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';
            }
            renderProducts(false); 
        }
        
        function renderProducts(forceFokusListUpdate) {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const productListEl = document.getElementById('product-list');
            productListEl.innerHTML = '';
            const productsToRender = config.products.filter(p => p.name.toLowerCase().includes(searchTerm));
            if (productsToRender.length === 0) {
                productListEl.innerHTML = `<p style="text-align: center; color: var(--text-light-color);">Produk "${searchTerm}" tidak ditemukan.</p>`;
                calculateAll();
                return;
            }
            const groupedProducts = productsToRender.reduce((acc, product) => {
                (acc[product.group] = acc[product.group] || []).push(product);
                return acc;
            }, {});
            for (const group in groupedProducts) {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-container';
                const sanitizedGroupName = sanitizeForCss(group);
                groupContainer.innerHTML = `<div class="group-header group-${sanitizedGroupName}">${group}</div>`;
                const tableView = document.createElement('div');
                tableView.className = 'product-table-view';
                tableView.innerHTML = `<div class="table-wrapper"><table class="product-table"><thead><tr><th>Produk</th><th>Stok Toko</th><th>Qty Order</th><th>Harga Nett/Karton</th><th>Subtotal</th><th>Harga Awal/Karton</th></tr></thead><tbody></tbody></table></div></div>`;
                const tableBody = tableView.querySelector('tbody');
                const cardView = document.createElement('div');
                cardView.className = 'product-card-view';
                groupedProducts[group].forEach(product => {
                    const orderQty = currentOrder[product.id] || { carton: '', box: '', stockCarton: '', stockBox: '' };
                    const tableRow = tableBody.insertRow();
                    tableRow.innerHTML = `<td><div class="product-name">${product.name}</div><div class="product-meta">${product.boxPerCarton} box/karton</div></td><td><div class="quantity-input"><button onclick="adjustQuantity('${product.id}', 'stockCarton', -1)">-</button><input type="number" min="0" value="${orderQty.stockCarton}" oninput="updateQuantity('${product.id}', 'stockCarton', this.value)" placeholder="Stok K"><button onclick="adjustQuantity('${product.id}', 'stockCarton', 1)">+</button></div><div class="quantity-input" style="margin-top: 4px;"><button onclick="adjustQuantity('${product.id}', 'stockBox', -1)">-</button><input type="number" min="0" value="${orderQty.stockBox}" oninput="updateQuantity('${product.id}', 'stockBox', this.value)" placeholder="Stok B"><button onclick="adjustQuantity('${product.id}', 'stockBox', 1)">+</button></div></td><td><div class="quantity-input"><button onclick="adjustQuantity('${product.id}', 'carton', -1)">-</button><input type="number" min="0" value="${orderQty.carton}" oninput="updateQuantity('${product.id}', 'carton', this.value)" placeholder="Karton"><button onclick="adjustQuantity('${product.id}', 'carton', 1)">+</button></div><div class="quantity-input" style="margin-top: 4px;"><button onclick="adjustQuantity('${product.id}', 'box', -1)">-</button><input type="number" min="0" value="${orderQty.box}" oninput="updateQuantity('${product.id}', 'box', this.value)" placeholder="Box"><button onclick="adjustQuantity('${product.id}', 'box', 1)">+</button></div></td><td id="nett-price-table-${product.id}">${formatCurrency(product.price)}</td><td id="subtotal-table-${product.id}">${formatCurrency(0)}</td><td>${formatCurrency(product.price)}</td>`;
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `<div class="card-header"><div class="product-name">${product.name}</div><div class="product-meta">${product.boxPerCarton} box/karton</div></div><div class="card-body"><div class="input-section"><div class="input-column"><label>Stok Toko</label><div class="quantity-input"><button onclick="adjustQuantity('${product.id}', 'stockCarton', -1)">-</button><input type="number" min="0" value="${orderQty.stockCarton}" oninput="updateQuantity('${product.id}', 'stockCarton', this.value)" placeholder="K"><button onclick="adjustQuantity('${product.id}', 'stockCarton', 1)">+</button></div><div class="quantity-input" style="margin-top: 4px;"><button onclick="adjustQuantity('${product.id}', 'stockBox', -1)">-</button><input type="number" min="0" value="${orderQty.stockBox}" oninput="updateQuantity('${product.id}', 'stockBox', this.value)" placeholder="B"><button onclick="adjustQuantity('${product.id}', 'stockBox', 1)">+</button></div></div><div class="input-column"><label>Qty Order</label><div class="quantity-input"><button onclick="adjustQuantity('${product.id}', 'carton', -1)">-</button><input type="number" min="0" value="${orderQty.carton}" oninput="updateQuantity('${product.id}', 'carton', this.value)" placeholder="K"><button onclick="adjustQuantity('${product.id}', 'carton', 1)">+</button></div><div class="quantity-input" style="margin-top: 4px;"><button onclick="adjustQuantity('${product.id}', 'box', -1)">-</button><input type="number" min="0" value="${orderQty.box}" oninput="updateQuantity('${product.id}', 'box', this.value)" placeholder="B"><button onclick="adjustQuantity('${product.id}', 'box', 1)">+</button></div></div></div><div class="price-section"><div><span class="price-label">Harga Nett/Karton:</span> <span id="nett-price-card-${product.id}">${formatCurrency(product.price)}</span></div><div><span class="price-label">Subtotal:</span> <span id="subtotal-card-${product.id}">${formatCurrency(0)}</span></div></div></div>`;
                    cardView.appendChild(productCard);
                });
                groupContainer.appendChild(tableView);
                groupContainer.appendChild(cardView);
                productListEl.appendChild(groupContainer);
            }
            calculateAll(forceFokusListUpdate);
        }

        function renderHistory() {
            const historyBody = document.getElementById('history-body');
            historyBody.innerHTML = '';
            savedOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${order.id}</td><td>${order.tokoName}</td><td>${new Date(order.date).toLocaleDateString('id-ID')}</td><td>${formatCurrency(order.summary.hargaNett)}</td><td class="history-actions"><button class="detail-btn" onclick="showDetailModal('${order.id}')">Detail</button><button class="edit-btn" onclick="loadOrderForEdit('${order.id}')">Edit</button><button class="export-btn" onclick="exportOrderFromHistory('${order.id}')">Ekspor</button><button class="delete-btn" onclick="deleteOrder('${order.id}')">Hapus</button></td>`;
                historyBody.appendChild(row);
            });
        }
        function renderDiscountList() {
            const container = document.getElementById('discount-list-container');
            let content = '<h3>Diskon Strata Pengambilan (Berdasarkan Nilai)</h3><h4>Grup Utama (Non-Simba)</h4><table class="info-table"><thead><tr><th>Minimal Pembelian</th><th>Diskon</th></tr></thead><tbody>' + config.discounts.strataPengambilan.main.tiers.map(t => `<tr><td>${formatCurrency(t.minValue)}</td><td>${(t.discount * 100).toFixed(2)}%</td></tr>`).join('') + '</tbody></table>' + '<h4>Grup SIMBA</h4><table class="info-table"><thead><tr><th>Minimal Pembelian</th><th>Diskon</th></tr></thead><tbody>' + config.discounts.strataPengambilan.simba.tiers.map(t => `<tr><td>${formatCurrency(t.minValue)}</td><td>${(t.discount * 100).toFixed(2)}%</td></tr>`).join('') + '</tbody></table><hr>' + '<h3>Diskon per Grouping (Berdasarkan Kuantitas)</h3>' + Object.keys(config.discounts.strataGrouping).map(group => `<h4>Grup ${group}</h4><table class="info-table"><thead><tr><th>Min Kuantitas (Karton)</th><th>Potongan per Karton</th></tr></thead><tbody>` + config.discounts.strataGrouping[group].map(t => `<tr><td>${t.minQty}</td><td>${formatCurrency(t.potongan)}</td></tr>`).join('') + '</tbody></table>').join('');
            
            // if (config.discounts.promoAmo) {
                const deal = config.discounts.promoAmo;
                content += `<hr><h3>Promo Tambahan AMO</h3><p style="font-size: 0.9em;">Berlaku untuk grup: <strong>${deal.appliesToGroups.join(', ')}</strong></p>
                <p style="font-size: 0.9em;">Syarat: Minimal <strong>${deal.minCartons} karton</strong> DAN <strong>${deal.minVariants} varian</strong> (per grup).</p>
                <p style="font-size: 0.9em;">Potongan: <strong>${formatCurrency(deal.potongan)} per karton</strong>.</p>`;
            }

            if (config.discounts.promoSpesial && config.discounts.promoSpesial.length > 0) {
                 config.discounts.promoSpesial.forEach(promo => {
                     if (promo.aktif) {
                         const applicableProducts = promo.syarat.produk.map(sku => config.products.find(p => p.id === sku)?.name || sku).join(', ');
                         content += `<hr><h3>${promo.nama}</h3><p style="font-size: 0.9em;">Diskon <strong>${(promo.potongan.nilai * 100)}%</strong> untuk produk: <strong>${applicableProducts}</strong>, jika total pembelian produk tsb. mencapai <strong>${formatCurrency(promo.syarat.minNilai)}</strong>.</p>`;
                     }
                  });
            }
            content += `<hr><h3>Diskon Lainnya</h3><p><strong>Diskon COD:</strong> ${config.discounts.cod.discount * 100}% jika total pembelian di atas ${formatCurrency(config.discounts.cod.minPurchase)}.</p>`;
            container.innerHTML = content;
        }
        function renderPromoPage() {
            const gallery = document.getElementById('promo-gallery');
            gallery.innerHTML = '';
            if (config.promoPosters && config.promoPosters.length > 0) {
                config.promoPosters.forEach(url => gallery.innerHTML += `<img src="${url}" alt="Poster Promo" onclick="showImageModal('${url}')">`);
            } else { gallery.innerHTML = '<p>Tidak ada info promo aktif saat ini.</p>'; }
        }
        function renderCatalogPage() {
            const gallery = document.getElementById('catalog-gallery');
            gallery.innerHTML = '';
            if (config.catalogPosters && config.catalogPosters.length > 0) {
                config.catalogPosters.forEach(url => gallery.innerHTML += `<img src="${url}" alt="Poster Katalog" onclick="showImageModal('${url}')">`);
            } else { gallery.innerHTML = '<p>Tidak ada katalog yang tersedia saat ini.</p>'; }
        }
        function calculateAll(forceFokusListUpdate = false) {
            const { summary, ...rest } = getCalculations(forceFokusListUpdate);
            updateUI({ summary, ...rest });
            return summary;
        }

        function getCalculations(forceFokusListUpdate = false) {
            let totalHargaAwal = 0, groupTotals = {}, orderLineItems = [];
            for (const productId in currentOrder) {
                const product = config.products.find(p => p.id === productId);
                if (!product) continue;
                const qtyInCartons = (parseFloat(currentOrder[productId].carton) || 0) + ((parseFloat(currentOrder[productId].box) || 0) / product.boxPerCarton);
                if (qtyInCartons > 0) {
                    const itemValue = qtyInCartons * product.price;
                    totalHargaAwal += itemValue;
                    if (!groupTotals[product.group]) groupTotals[product.group] = { totalCartons: 0, totalValue: 0 };
                    groupTotals[product.group].totalCartons += qtyInCartons;
                    orderLineItems.push({ product, qtyInCartons, itemValue, id: productId });
                }
            }

            let diskonStrataRp = 0;
            let totalBruttoMain = 0, totalBruttoSimba = 0;
            orderLineItems.forEach(line => {
                if (config.discounts.strataPengambilan.main.appliesTo.includes(line.product.group)) totalBruttoMain += line.itemValue;
                if (config.discounts.strataPengambilan.simba.appliesTo.includes(line.product.group)) totalBruttoSimba += line.itemValue;
            });
            const mainTier = config.discounts.strataPengambilan.main.tiers.find(t => totalBruttoMain >= t.minValue);
            if (mainTier) diskonStrataRp += totalBruttoMain * mainTier.discount;
            const simbaTier = config.discounts.strataPengambilan.simba.tiers.find(t => totalBruttoSimba >= t.minValue);
            if (simbaTier) diskonStrataRp += totalBruttoSimba * simbaTier.discount;
            const subtotalSetelahStrata = totalHargaAwal - diskonStrataRp;

            const dealKhususAktif = document.getElementById('deal-khusus-checkbox').checked;
            const dealKhususPerKarton = parseFloat(document.getElementById('deal-khusus-input').value) || 0;
            const dealKhususSKUs = ["SKU011", "SKU012", "SKU013", "SKU014", "SKU015"];
            let totalDiskonPotongan = 0;
            
            // orderLineItems.forEach(line => {
                let itemPotonganTotal = 0;
                const groupingTier = config.discounts.strataGrouping[line.product.group]?.find(t => groupTotals[line.product.group].totalCartons >= t.minQty);
                if (groupingTier) itemPotonganTotal += line.qtyInCartons * groupingTier.potongan;
                
                // Logika promo 5k DIHAPUS dari sini
                
                if (dealKhususAktif && dealKhususPerKarton > 0 && dealKhususSKUs.includes(line.id)) itemPotonganTotal += line.qtyInCartons * dealKhususPerKarton;
                line.itemPotongan = itemPotonganTotal;
                totalDiskonPotongan += itemPotonganTotal;
            });

            // --- LOGIKA PROMO AMO BARU DIMULAI DI SINI ---
            if (document.getElementById('promo-amo-checkbox').checked && config.discounts.promoAmo) {
                const promoConfig = config.discounts.promoAmo;
                
                promoConfig.appliesToGroups.forEach(groupName => {
                    const itemsInGroup = orderLineItems.filter(line => line.product.group === groupName);
                    const totalCartonsInGroup = itemsInGroup.reduce((sum, line) => sum + line.qtyInCartons, 0);
                    const totalVariantsInGroup = new Set(itemsInGroup.map(line => line.id)).size;

                    // Cek kedua syarat
                    if (totalCartonsInGroup >= promoConfig.minCartons && totalVariantsInGroup >= promoConfig.minVariants) {
                        // Jika lolos, tambahkan potongan ke setiap item di grup itu
                        itemsInGroup.forEach(line => {
                            const itemPotonganAmo = line.qtyInCartons * promoConfig.potongan;
                            line.itemPotongan += itemPotonganAmo; // Tambahkan ke itemPotongan yang sudah ada
                            totalDiskonPotongan += itemPotonganAmo; // Tambahkan ke total diskon potongan
                        });
                    }
                });
            }
            // --- LOGIKA PROMO AMO SELESAI ---

            const subtotalSetelahPotongan = subtotalSetelahStrata - totalDiskonPotongan;
            // let diskonPromoSpesialRp = 0;
            const activePromos = [];
            if (config.discounts.promoSpesial && Array.isArray(config.discounts.promoSpesial)) {
                config.discounts.promoSpesial.forEach(promo => {
                    if (!promo.aktif) return;
                    const subtotalPromoItems = orderLineItems
                        .filter(line => promo.syarat.produk.includes(line.id))
                        .reduce((sum, line) => sum + line.itemValue, 0);
                    
                    if (subtotalPromoItems >= promo.syarat.minNilai) {
                        const basisPerhitungan = (promo.potongan.berlakuUntuk === 'produk_promo') ? subtotalPromoItems : subtotalSetelahPotongan;
                        const nilaiPotongan = basisPerhitungan * promo.potongan.nilai;
                        diskonPromoSpesialRp += nilaiPotongan;
                        activePromos.push({ promo, subtotalPromoItems });
                    }
                });
            }
            const subtotalSetelahPromoSpesial = subtotalSetelahPotongan - diskonPromoSpesialRp;

            let diskonCodRp = 0;
            if (document.getElementById('cod-checkbox').checked && totalHargaAwal >= config.discounts.cod.minPurchase) {
                diskonCodRp = subtotalSetelahPromoSpesial * config.discounts.cod.discount;
            }
            
            const diskonVoucherPersen = (parseFloat(document.getElementById('voucher-class-dropdown').value) || 0); 

            const isAlokasiAktif = document.getElementById('voucher-alokasi-checkbox').checked;
            const selectedSkus = isAlokasiAktif ? Array.from(document.querySelectorAll('.fokus-checkbox:checked')).map(cb => cb.value) : [];
            
            let totalNettDariItem = 0;
            let totalDiskonVoucherRp = 0; 

            orderLineItems.forEach((line) => {
                let subtotalItem = line.itemValue;
                let diskonStrataItem = 0;
                if (mainTier && config.discounts.strataPengambilan.main.appliesTo.includes(line.product.group)) diskonStrataItem = line.itemValue * mainTier.discount;
                else if (simbaTier && config.discounts.strataPengambilan.simba.appliesTo.includes(line.product.group)) diskonStrataItem = line.itemValue * simbaTier.discount;
                subtotalItem -= diskonStrataItem;
                subtotalItem -= line.itemPotongan; // itemPotongan sekarang sudah termasuk promo AMO jika ada

                activePromos.forEach(({ promo, subtotalPromoItems }) => {
                    if (promo.syarat.produk.includes(line.id) && subtotalPromoItems > 0) {
                        const basisPerhitungan = (promo.potongan.berlakuUntuk === 'produk_promo') ? subtotalPromoItems : subtotalSetelahPotongan;
                        const totalPotonganPromo = basisPerhitungan * promo.potongan.nilai;
                        const porsiPromo = (line.itemValue / subtotalPromoItems) * totalPotonganPromo;
                        subtotalItem -= porsiPromo;
                    }
                });

                if (document.getElementById('cod-checkbox').checked && totalHargaAwal >= config.discounts.cod.minPurchase) {
                    subtotalItem -= subtotalItem * config.discounts.cod.discount;
                }
                
                let itemDiskonVoucherRp = 0;
                if (diskonVoucherPersen > 0) {
                    if (!isAlokasiAktif) {
                        itemDiskonVoucherRp = subtotalItem * diskonVoucherPersen;
                    } else if (isAlokasiAktif && selectedSkus.includes(line.id)) {
                        itemDiskonVoucherRp = subtotalItem * diskonVoucherPersen;
                    }
                }
                
                subtotalItem -= itemDiskonVoucherRp; 
                totalDiskonVoucherRp += itemDiskonVoucherRp; 

                line.subtotalNett = Math.round(subtotalItem);
                totalNettDariItem += line.subtotalNett;
            });

            const hargaNett = totalNettDariItem;
            const totalDiskon = totalHargaAwal > 0 ? totalHargaAwal - hargaNett : 0;
            
            orderLineItems.forEach(line => {
                 line.nettPricePerCarton = line.qtyInCartons > 0 ? line.subtotalNett / line.qtyInCartons : 0;
            });

            if (forceFokusListUpdate) updateFokusCheckboxes(orderLineItems);

            // let diskonGroupingRp = 0, diskonAmoRp = 0, diskonDealKhususRp = 0;
            if (document.getElementById('promo-amo-checkbox').checked && config.discounts.promoAmo) {
                const promoConfig = config.discounts.promoAmo;
                promoConfig.appliesToGroups.forEach(groupName => {
                    const itemsInGroup = orderLineItems.filter(line => line.product.group === groupName);
                    const totalCartonsInGroup = itemsInGroup.reduce((sum, line) => sum + line.qtyInCartons, 0);
                    const totalVariantsInGroup = new Set(itemsInGroup.map(line => line.id)).size;
                    if (totalCartonsInGroup >= promoConfig.minCartons && totalVariantsInGroup >= promoConfig.minVariants) {
                        itemsInGroup.forEach(line => {
                            diskonAmoRp += line.qtyInCartons * promoConfig.potongan;
                        });
                    }
                });
            }
            
            orderLineItems.forEach(line => {
                const groupingTier = config.discounts.strataGrouping[line.product.group]?.find(t => groupTotals[line.product.group].totalCartons >= t.minQty);
                if (groupingTier) diskonGroupingRp += line.qtyInCartons * groupingTier.potongan;
                // Logika promo 5k dihapus dari sini
                if (dealKhususAktif && dealKhususPerKarton > 0 && dealKhususSKUs.includes(line.id)) diskonDealKhususRp += line.qtyInCartons * dealKhususPerKarton;
            });

            return {
                summary: {
                    totalHargaAwal, totalDiskon, hargaNett,
                    diskonBreakdown: {
                        strata: Math.round(diskonStrataRp),
                        grouping: Math.round(diskonGroupingRp + diskonAmoRp), // <-- Diubah di sini
                        dealKhusus: Math.round(diskonDealKhususRp),
                        promoSpesial: Math.round(diskonPromoSpesialRp),
                        cod: Math.round(diskonCodRp),
                        voucher: Math.round(totalDiskonVoucherRp), 
                    }
                },
                orderLineItems, mainValue: totalBruttoMain, simbaValue: totalBruttoSimba, groupTotals
            };
            // }

        function updateFokusCheckboxes(orderLineItems) {
            const listContainer = document.getElementById('voucher-fokus-list');
            const savedCheckedSkus = Array.from(document.querySelectorAll('.fokus-checkbox:checked')).map(cb => cb.value);
            listContainer.innerHTML = '';
            if (orderLineItems.length > 0) {
                orderLineItems.forEach(line => {
                    const itemDiv = document.createElement('div');
                    const itemLabel = document.createElement('label');
                    const itemCheckbox = document.createElement('input');
                    itemCheckbox.type = 'checkbox'; itemCheckbox.className = 'fokus-checkbox'; itemCheckbox.value = line.id;
                    if (savedCheckedSkus.includes(line.id)) itemCheckbox.checked = true;
                    itemCheckbox.addEventListener('change', () => { calculateAll(false); saveDraft(); });
                    itemLabel.appendChild(itemCheckbox);
                    itemLabel.appendChild(document.createTextNode(` ${line.product.name}`));
                    itemDiv.appendChild(itemLabel); listContainer.appendChild(itemDiv);
                });
            } else { listContainer.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-light-color); text-align: center; margin: 0;">Belum ada produk di order.</p>'; }
        }
        function updateUI({ summary, orderLineItems, mainValue, simbaValue, groupTotals }) {
            config.products.forEach(product => {
                const line = orderLineItems.find(l => l.id === product.id);
                const subtotalNett = line ? line.subtotalNett : 0; const nettPricePerCarton = line ? line.nettPricePerCarton : 0;
                const nettPriceTableEl = document.getElementById(`nett-price-table-${product.id}`);
                if (nettPriceTableEl) nettPriceTableEl.textContent = formatCurrency(nettPricePerCarton);
                const subtotalTableEl = document.getElementById(`subtotal-table-${product.id}`);
                if (subtotalTableEl) subtotalTableEl.textContent = formatCurrency(subtotalNett);
                const nettPriceCardEl = document.getElementById(`nett-price-card-${product.id}`);
                if (nettPriceCardEl) nettPriceCardEl.textContent = formatCurrency(nettPricePerCarton);
                const subtotalCardEl = document.getElementById(`subtotal-card-${product.id}`);
                if (subtotalCardEl) subtotalCardEl.textContent = formatCurrency(subtotalNett);
            });
            document.getElementById('summary-harga-nett-collapsed').textContent = formatCurrency(summary.hargaNett);
            document.getElementById('summary-harga-nett-expanded').textContent = formatCurrency(summary.hargaNett);
            document.getElementById('summary-harga-awal').textContent = formatCurrency(summary.totalHargaAwal);
            document.getElementById('summary-total-diskon').textContent = formatCurrency(summary.totalDiskon);
            const breakdown = summary.diskonBreakdown;
            document.getElementById('summary-diskon-breakdown').innerHTML = `Strata: ${formatCurrency(breakdown.strata)} | Grouping: ${formatCurrency(breakdown.grouping)} | Deal: ${formatCurrency(breakdown.dealKhusus)} | Promo: ${formatCurrency(breakdown.promoSpesial)} | COD: ${formatCurrency(breakdown.cod)} | Voucher: ${formatCurrency(breakdown.voucher)}`;
            displayUpsell(mainValue, simbaValue, groupTotals, orderLineItems);
        }
        function displayUpsell(mainValue, simbaValue, groupTotals, orderLineItems) {
            const upsellGrid = document.getElementById('upsell-grid'); let upsellMessages = [];
            const processStrataUpsell = (currentValue, strataConfig, groupName) => {
                const currentTier = strataConfig.tiers.find(t => currentValue >= t.minValue);
                const nextTier = [...strataConfig.tiers].reverse().find(t => currentValue < t.minValue);
                if (nextTier) {
                    const currentDiscountPercent = (currentTier?.discount || 0) * 100;
                    upsellMessages.push(`<div class="upsell-item goal"><strong>Total ${groupName}:</strong> ${formatCurrency(currentValue)} (Diskon: <strong>${currentDiscountPercent.toFixed(2)}%</strong>).<br><strong>Tier berikutnya:</strong> ${formatCurrency(nextTier.minValue)} (Diskon: <strong>${(nextTier.discount * 100).toFixed(2)}%</strong>).</div>`);
                } else if (currentTier && currentValue > 0) upsellMessages.push(`<div class="upsell-item achieved"><strong>Total ${groupName}:</strong> <strong>Selamat!</strong> Anda mencapai diskon tertinggi (<strong>${(currentTier.discount * 100).toFixed(2)}%</strong>).</div>`);
            };
            processStrataUpsell(mainValue, config.discounts.strataPengambilan.main, 'Order');
            processStrataUpsell(simbaValue, config.discounts.strataPengambilan.simba, 'SIMBA');
            
            for (const groupName in config.discounts.strataGrouping) {
                const groupQty = groupTotals[groupName]?.totalCartons || 0;
                if (groupQty > 0) {
                    const currentTier = config.discounts.strataGrouping[groupName].find(t => groupQty >= t.minQty);
                    const nextGroupTier = [...config.discounts.strataGrouping[groupName]].reverse().find(t => groupQty < t.minQty);
                    if (nextGroupTier) {
                        upsellMessages.push(`<div class="upsell-item goal"><strong>Grup ${groupName}:</strong> Jumlah <strong>${groupQty.toFixed(2)} karton</strong> (Potongan: <strong>${formatCurrency(currentTier?.potongan || 0)}/k</strong>).<br><strong>Tier berikutnya:</strong> <strong>${nextGroupTier.minQty} karton</strong> (Potongan: <strong>${formatCurrency(nextGroupTier.potongan)}/k</strong>).</div>`);
                    } else if (currentTier) {
                        upsellMessages.push(`<div class="upsell-item achieved"><strong>Grup ${groupName}:</strong> <strong>Selamat!</strong> Anda mencapai potongan tertinggi (<strong>${formatCurrency(currentTier.potongan)}/karton</strong>).</div>`);
                    }
                }
            }
            
            // if (document.getElementById('promo-amo-checkbox').checked && config.discounts.promoAmo) {
                const promoConfig = config.discounts.promoAmo;
                promoConfig.appliesToGroups.forEach(groupName => {
                    const itemsInGroup = orderLineItems.filter(line => line.product.group === groupName);
                    const totalCartonsInGroup = itemsInGroup.reduce((sum, line) => sum + line.qtyInCartons, 0);
                    const totalVariantsInGroup = new Set(itemsInGroup.map(line => line.id)).size;
                    
                    if (totalCartonsInGroup > 0) { // Hanya tampilkan jika user membeli grup tsb.
                        if (totalCartonsInGroup >= promoConfig.minCartons && totalVariantsInGroup >= promoConfig.minVariants) {
                            upsellMessages.push(`<div class="upsell-item achieved"><strong>Promo AMO (${groupName}):</strong> <strong>Selamat!</strong> Anda mendapat potongan <strong>${formatCurrency(promoConfig.potongan)}/karton</strong>.</div>`);
                        } else {
                            let goalMsg = `<strong>Promo AMO (${groupName}):</strong> `;
                            if (totalCartonsInGroup < promoConfig.minCartons) goalMsg += `Tambah <strong>${(promoConfig.minCartons - totalCartonsInGroup).toFixed(2)} karton</strong> lagi. `;
                            if (totalVariantsInGroup < promoConfig.minVariants) goalMsg += `Tambah <strong>${(promoConfig.minVariants - totalVariantsInGroup)} varian</strong> lagi.`;
                            upsellMessages.push(`<div class="upsell-item goal">${goalMsg}<br>Untuk dapat potongan <strong>${formatCurrency(promoConfig.potongan)}/karton</strong>.</div>`);
                        }
                    }
                });
            }
            // if (config.discounts.promoSpesial && Array.isArray(config.discounts.promoSpesial)) {
                config.discounts.promoSpesial.forEach(promo => {
                    if (!promo.aktif) return;
                    const subtotalPromoItems = orderLineItems
                        .filter(line => promo.syarat.produk.includes(line.id))
                        .reduce((sum, line) => sum + line.itemValue, 0);
                    
                    if (subtotalPromoItems < promo.syarat.minNilai && subtotalPromoItems > 0) {
                        const sisa = promo.syarat.minNilai - subtotalPromoItems;
                        upsellMessages.push(`<div class="upsell-item goal"><strong>${promo.nama}:</strong> Belanja produk promo <strong>${formatCurrency(subtotalPromoItems)}</strong>.<br>Tambah <strong>${formatCurrency(sisa)}</strong> lagi utk dpt diskon <strong>${(promo.potongan.nilai * 100)}%</strong>.</div>`);
                    } else if (subtotalPromoItems >= promo.syarat.minNilai) {
                        upsellMessages.push(`<div class="upsell-item achieved"><strong>${promo.nama}:</strong> <strong>Selamat!</strong> Anda mendapatkan diskon <strong>${(promo.potongan.nilai * 100)}%</strong>.</div>`);
                    }
                });
            }
            
            const upsellContainer = document.querySelector('.upsell-outer-container');
            if (upsellMessages.length > 0) { upsellContainer.style.display = 'block'; upsellGrid.innerHTML = upsellMessages.join(''); }
            else { upsellContainer.style.display = 'none'; upsellGrid.innerHTML = ''; }
        }
        function adjustQuantity(productId, type, amount) {
            const inputs = document.querySelectorAll(`input[oninput="updateQuantity('${productId}', '${type}', this.value)"]`);
            if (inputs.length > 0) {
                let currentValue = parseFloat(inputs[0].value) || 0; let newValue = currentValue + amount;
                if (newValue < 0) newValue = 0;
                inputs.forEach(input => input.value = newValue); updateQuantity(productId, type, newValue);
            }
        }
        function updateQuantity(productId, type, value) {
            if (!currentOrder[productId]) currentOrder[productId] = { carton: '', box: '', stockCarton: '', stockBox: '' };
            const numericValue = parseFloat(value);
            currentOrder[productId][type] = isNaN(numericValue) ? '' : numericValue;
            document.querySelectorAll(`input[oninput="updateQuantity('${productId}', '${type}', this.value)"]`).forEach(input => { if (input.value !== value) { input.value = value; } });
            if (type === 'carton' || type === 'box') calculateAll(true);
            saveDraft();
        }
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            document.querySelector(`.tab-button[onclick="showPage('${pageName}')"]`).classList.add('active');
            if (pageName === 'riwayat') renderHistory(); if (pageName === 'diskon') renderDiscountList();
            if (pageName === 'promo') renderPromoPage(); if (pageName === 'katalog') renderCatalogPage();
            if (pageName === 'loyalty') populateLoyaltyTable();
        }
        function saveOrder() {
            const tokoName = document.getElementById('toko-name-input').value.trim();
            if (!tokoName) { alert('Silakan masukkan nama toko.'); return; }
            const { summary, orderLineItems } = getCalculations(false);
            if (summary.totalHargaAwal === 0) { alert('Tidak ada produk dalam order.'); return; }
            const itemsToSave = {};
            for (const productId in currentOrder) {
                const item = currentOrder[productId];
                if ((parseFloat(item.carton) || 0) > 0 || (parseFloat(item.box) || 0) > 0 || (parseFloat(item.stockCarton) || 0) > 0 || (parseFloat(item.stockBox) || 0) > 0) {
                    const productInfo = config.products.find(p => p.id === productId);
                    const financialData = orderLineItems.find(line => line.id === productId) || { nettPricePerCarton: 0, subtotalNett: 0 };
                    itemsToSave[productId] = { name: productInfo.name, ...item, nettPricePerCarton: financialData.nettPricePerCarton, subtotalNett: financialData.subtotalNett };
                }
            }
            const orderToSave = {
                tokoName, summary, items: itemsToSave, date: new Date().toISOString(),
                cod: document.getElementById('cod-checkbox').checked,
                voucherDiscount: parseFloat(document.getElementById('voucher-class-dropdown').value) || 0,
                alokasiDiskon: document.getElementById('voucher-alokasi-checkbox').checked,
                promoAmo: document.getElementById('promo-amo-checkbox').checked, // <-- PERUBAHAN 7B
                dealKhususAktif: document.getElementById('deal-khusus-checkbox').checked,
                dealKhususNominal: parseFloat(document.getElementById('deal-khusus-input').value) || 0,
                fokusAlokasi: Array.from(document.querySelectorAll('.fokus-checkbox:checked')).map(cb => cb.value)
            };
            if (editingOrderId) {
                const index = savedOrders.findIndex(o => o.id === editingOrderId);
                if (index !== -1) savedOrders[index] = { ...orderToSave, id: editingOrderId };
            } else { savedOrders.unshift({ ...orderToSave, id: 'ORD-' + Date.now() }); }
            localStorage.setItem((typeof config !== 'undefined' && config.STORAGE_KEY) ? config.STORAGE_KEY : 'pma_saved_orders', JSON.stringify(savedOrders));
            alert(`Order untuk "${tokoName}" berhasil disimpan!`); resetOrder();
        }
        
        function exportOrderFromHistory(orderId) {
            const orderToExport = savedOrders.find(o => o.id === orderId); if (!orderToExport) { alert('Order tidak ditemukan!'); return; }
            const dataForExcel = [];
            const currentDate = new Date(orderToExport.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            dataForExcel.push(['Order untuk Toko:', orderToExport.tokoName]); dataForExcel.push(['Tanggal Order:', currentDate]); dataForExcel.push([]);
            const itemHeaders = ['Grup Produk', 'SKU', 'Nama Produk', 'Qty (Karton)', 'Qty (Box)', 'Harga Nett/Karton', 'Subtotal Nett'];
            dataForExcel.push(itemHeaders);
            const sortedItems = Object.keys(orderToExport.items).map(itemId => {
                const itemData = orderToExport.items[itemId];
                const productInfo = config.products.find(p => p.id === itemId) || { group: 'ZZZ-Lainnya', name: itemData.name };
                return { ...itemData, id: itemId, group: productInfo.group, name: productInfo.name };
            });
            sortedItems.sort((a, b) => { const groupCompare = a.group.localeCompare(b.group); if (groupCompare !== 0) return groupCompare; return a.name.localeCompare(b.name); });
            sortedItems.forEach(item => { if ((parseFloat(item.carton) || 0) > 0 || (parseFloat(item.box) || 0) > 0) { dataForExcel.push([item.group, item.id, item.name, item.carton || 0, item.box || 0, item.nettPricePerCarton, item.subtotalNett]); } });
            const summary = orderToExport.summary; dataForExcel.push([]);
            dataForExcel.push(['', '', '', '', '', 'Total Harga Awal:', summary.totalHargaAwal]);
            dataForExcel.push(['', '', '', '', '', 'Total Diskon:', summary.totalDiskon]);
            dataForExcel.push(['', '', '', '', '', 'HARGA NETT FINAL:', summary.hargaNett]);
            const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
            ws['!cols'] = [ { wch: 20 }, { wch: 10 }, { wch: 40 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 20 } ];
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Detail Order');
            const fileName = `Order_${orderToExport.tokoName.replace(/ /g, '_')}_${new Date(orderToExport.date).toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetOrder() {
            currentOrder = {}; editingOrderId = null;
            document.getElementById('toko-name-input').value = ''; document.getElementById('cod-checkbox').checked = true;
            document.getElementById('voucher-alokasi-checkbox').checked = false; 
            document.getElementById('promo-amo-checkbox').checked = true; // <-- PERUBAHAN 7C
            document.getElementById('deal-khusus-checkbox').checked = false; document.getElementById('deal-khusus-input').value = '';
            document.getElementById('voucher-class-dropdown').value = '0'; 
            document.getElementById('fokus-alokasi-container').style.display = 'none'; document.querySelector('.order-actions button').textContent = "Simpan Order";
            document.getElementById('search-input').value = ''; document.getElementById('clear-search-btn').style.display = 'none';
            localStorage.removeItem(DRAFT_KEY); renderProducts(true);
        }
        function loadOrderForEdit(orderId) {
            localStorage.removeItem(DRAFT_KEY);
            const orderToEdit = savedOrders.find(o => o.id === orderId); if (!orderToEdit) return;
            currentOrder = {};
            for (const productId in orderToEdit.items) { currentOrder[productId] = { carton: orderToEdit.items[productId].carton, box: orderToEdit.items[productId].box, stockCarton: orderToEdit.items[productId].stockCarton, stockBox: orderToEdit.items[productId].stockBox }; }
            editingOrderId = orderId;
            document.getElementById('toko-name-input').value = orderToEdit.tokoName; document.getElementById('cod-checkbox').checked = orderToEdit.cod;
            document.getElementById('voucher-class-dropdown').value = orderToEdit.voucherDiscount || '0'; 
            document.getElementById('promo-amo-checkbox').checked = orderToEdit.promoAmo || false; // <-- PERUBAHAN 7D
            document.getElementById('deal-khusus-checkbox').checked = orderToEdit.dealKhususAktif || false; document.getElementById('deal-khusus-input').value = orderToEdit.dealKhususNominal || '';
            document.querySelector('.order-actions button').textContent = "Update Order";
            const alokasiCheckbox = document.getElementById('voucher-alokasi-checkbox'); alokasiCheckbox.checked = orderToEdit.alokasiDiskon || false;
            document.getElementById('fokus-alokasi-container').style.display = alokasiCheckbox.checked ? 'block' : 'none';
            document.getElementById('search-input').value = ''; document.getElementById('clear-search-btn').style.display = 'none';
            showPage('kalkulator'); renderProducts(true);
            const skusToCheck = orderToEdit.fokusAlokasi;
            if (Array.isArray(skusToCheck)) { skusToCheck.forEach(sku => { const cb = document.querySelector(`.fokus-checkbox[value="${sku}"]`); if (cb) cb.checked = true; }); }
            calculateAll(false); saveDraft();
        }
        function deleteOrder(orderId) {
            if (confirm('Yakin ingin menghapus order ini?')) {
                savedOrders = savedOrders.filter(o => o.id !== orderId);
                localStorage.setItem((typeof config !== 'undefined' && config.STORAGE_KEY) ? config.STORAGE_KEY : 'pma_saved_orders', JSON.stringify(savedOrders));
                renderHistory();
            }
        }
        
        function showDetailModal(orderId) {
            const order = savedOrders.find(o => o.id === orderId); if (!order) return;
            document.getElementById('modal-title').textContent = `Detail Order: ${order.tokoName}`;
            const body = document.getElementById('modal-body');
            let content = `<p><strong>Tanggal:</strong> ${new Date(order.date).toLocaleString('id-ID')}</p>`;
            content += '<h4>Item yang Dipesan & Stok:</h4><table class="info-table"><thead><tr><th>Produk</th><th>Kuantitas</th><th>Stok</th><th>Harga Nett/Karton</th><th>Subtotal Nett</th></tr></thead><tbody>';
            const sortedItems = Object.keys(order.items).map(itemId => {
                const itemData = order.items[itemId]; const productInfo = config.products.find(p => p.id === itemId) || { group: 'ZZZ-Lainnya', name: itemData.name };
                return { ...itemData, group: productInfo.group, name: productInfo.name };
            });
            sortedItems.sort((a, b) => { const groupCompare = a.group.localeCompare(b.group); if (groupCompare !== 0) return groupCompare; return a.name.localeCompare(b.name); });
            sortedItems.forEach(item => {
                if (((parseFloat(item.carton) || 0) > 0 || (parseFloat(item.box) || 0) > 0) || ((parseFloat(item.stockCarton) || 0) > 0 || (parseFloat(item.stockBox) || 0) > 0)) {
                    const stockDisplay = (item.stockCarton || item.stockBox) ? `${item.stockCarton || 0} K, ${item.stockBox || 0} B` : '-';
                    content += `<tr><td><b>[${item.group}]</b><br>${item.name}</td><td>${item.carton || 0} K, ${item.box || 0} B</td><td>${stockDisplay}</td><td>${formatCurrency(item.nettPricePerCarton)}</td><td>${formatCurrency(item.subtotalNett)}</td></tr>`;
                }
            });
            content += '</tbody></table><h4>Ringkasan Finansial:</h4>';
            const breakdown = order.summary.diskonBreakdown;
            content += `<p><strong>Total Harga Awal:</strong> ${formatCurrency(order.summary.totalHargaAwal)}</p><p><strong>Rincian Diskon:</strong> Strata: ${formatCurrency(breakdown.strata)} | Grouping: ${formatCurrency(breakdown.grouping)} | Deal: ${formatCurrency(breakdown.dealKhusus)} | Promo: ${formatCurrency(breakdown.promoSpesial)} | COD: ${formatCurrency(breakdown.cod)} | Voucher: ${formatCurrency(breakdown.voucher || 0)}</p><p><strong>Total Diskon:</strong> ${formatCurrency(order.summary.totalDiskon)}</p><h3>Harga Nett: ${formatCurrency(order.summary.hargaNett)}</h3>`;
            body.innerHTML = content; document.getElementById('detail-modal').style.display = 'flex';
        }
        
        function showCurrentOrderDetail() {
            const { summary, orderLineItems } = getCalculations(false);
            const tokoName = document.getElementById('toko-name-input').value.trim() || "Order Saat Ini";
            document.getElementById('modal-title').textContent = `Detail Order: ${tokoName}`;
            const body = document.getElementById('modal-body');
            let content = `<p><strong>Tanggal:</strong> ${new Date().toLocaleString('id-ID')}</p>`;
            content += '<h4>Item yang Dipesan & Stok:</h4><table class="info-table"><thead><tr><th>Produk</th><th>Kuantitas</th><th>Stok</th><th>Harga Nett/Karton</th><th>Subtotal Nett</th></tr></thead><tbody>';
            const sortedItems = [];
            for (const productId in currentOrder) {
                const itemDetails = currentOrder[productId];
                if (((parseFloat(itemDetails.carton) || 0) > 0 || (parseFloat(itemDetails.box) || 0) > 0) || ((parseFloat(itemDetails.stockCarton) || 0) > 0 || (parseFloat(itemDetails.stockBox) || 0) > 0)) {
                    const product = config.products.find(p => p.id === productId); const financialData = orderLineItems.find(line => line.id === productId) || {};
                    sortedItems.push({ ...itemDetails, group: product.group, name: product.name, nettPricePerCarton: financialData.nettPricePerCarton || 0, subtotalNett: financialData.subtotalNett || 0 });
                }
            }
            sortedItems.sort((a, b) => { const groupCompare = a.group.localeCompare(b.group); if (groupCompare !== 0) return groupCompare; return a.name.localeCompare(b.name); });
            sortedItems.forEach(item => {
                const stockDisplay = (item.stockCarton || item.stockBox) ? `${item.stockCarton || 0} K, ${item.stockBox || 0} B` : '-';
                content += `<tr><td><b>[${item.group}]</b><br>${item.name}</td><td>${item.carton || 0} K, ${item.box || 0} B</td><td>${stockDisplay}</td><td>${formatCurrency(item.nettPricePerCarton)}</td><td>${formatCurrency(item.subtotalNett)}</td></tr>`;
            });
            content += '</tbody></table><h4>Ringkasan Finansial:</h4>';
            const breakdown = summary.diskonBreakdown;
            content += `<p><strong>Total Harga Awal:</strong> ${formatCurrency(summary.totalHargaAwal)}</p><p><strong>Rincian Diskon:</strong><br>Strata: ${formatCurrency(breakdown.strata)} | Grouping: ${formatCurrency(breakdown.grouping)} | Deal: ${formatCurrency(breakdown.dealKhusus)} | Promo: ${formatCurrency(breakdown.promoSpesial)}<br>COD: ${formatCurrency(breakdown.cod)} | Voucher: ${formatCurrency(breakdown.voucher || 0)}</p><p><strong>Total Diskon:</strong> ${formatCurrency(summary.totalDiskon)}</p><h3>Harga Nett: ${formatCurrency(summary.hargaNett)}</h3>`;
            body.innerHTML = content; document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeDetailModal() { document.getElementById('detail-modal').style.display = 'none'; }
        function showImageModal(src) { document.getElementById('modal-image-src').src = src; document.getElementById('image-modal').style.display = 'flex'; }
        function closeImageModal() { document.getElementById('image-modal').style.display = 'none'; }
        function setViewMode() {
            const productListEl = document.getElementById('product-list');
            if (window.innerWidth <= 768) { productListEl.classList.add('mobile-view'); productListEl.classList.remove('desktop-view'); }
            else { productListEl.classList.add('desktop-view'); productListEl.classList.remove('mobile-view'); }
        }
        function populateLoyaltyTable() {
            const tableBody = document.querySelector("#loyalty-info-table tbody");
            if (!tableBody || !config.loyaltyTiers) return; tableBody.innerHTML = '';
            config.loyaltyTiers.forEach(tier => {
                const row = document.createElement('tr');
                const rangeMax = isFinite(tier.max) ? formatCurrency(tier.max) : 'UP';
                row.innerHTML = `<td><b>${tier.class}</b></td><td>${formatCurrency(tier.min)} - ${rangeMax}</td><td>${(tier.rates['4'] * 100).toFixed(3)}%</td><td>${(tier.rates['3'] * 100).toFixed(3)}%</td><td>${(tier.rates['2'] * 100).toFixed(3)}%</td><td>${(tier.rates['1'] * 100).toFixed(3)}%</td>`;
                tableBody.appendChild(row);
            });
        }
        
        function populateVoucherClassDropdown() {
            const selectEl = document.getElementById('voucher-class-dropdown');
            if (!selectEl || !config.loyaltyTiers) return;

            // Kosongkan opsi (sisakan yang default)
            selectEl.innerHTML = '<option value="0">Tanpa Voucher Loyalty</option>'; 

            config.loyaltyTiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.rates['4']; 
                option.text = `${tier.class} (${(tier.rates['4'] * 100).toFixed(3)}%)`;
                selectEl.appendChild(option);
            });
        }
        
        function calculateLoyalty() {
            const omzetInput = document.getElementById('monthly-omzet-input');
            const weeklySelect = document.getElementById('weekly-achievement-select');
            const resultDiv = document.getElementById('loyalty-result');
            const omzet = parseFloat(omzetInput.value.replace(/\./g, ''));
            const weeklyTier = weeklySelect.value;
            if (isNaN(omzet) || omzet <= 0) { alert("Silakan masukkan jumlah omzet yang valid."); return; }
            const foundTier = config.loyaltyTiers.find(tier => omzet >= tier.min && omzet <= tier.max);
            if (foundTier) {
                const rate = foundTier.rates[weeklyTier]; const nominal = omzet * rate;
                document.getElementById('loyalty-result-kelas').textContent = foundTier.class;
                document.getElementById('loyalty-result-persen').textContent = `${(rate * 100).toFixed(3)}%`;
                document.getElementById('loyalty-result-nominal').textContent = formatCurrency(nominal);
                resultDiv.style.display = 'block';
            } else {
                document.getElementById('loyalty-result-kelas').textContent = "Tidak Masuk Kelas";
                document.getElementById('loyalty-result-persen').textContent = "0%";
                document.getElementById('loyalty-result-nominal').textContent = "Rp 0";
                resultDiv.style.display = 'block';
            }
        }
        function initializeApp() {
            const savedDraft = localStorage.getItem(DRAFT_KEY);
            if (savedDraft) {
                if (confirm("Kami menemukan draf order yang belum disimpan. Apakah Anda ingin melanjutkannya?")) {
                    const draft = JSON.parse(savedDraft);
                    currentOrder = draft.order || {};
                    document.getElementById('toko-name-input').value = draft.tokoName || '';
                    document.getElementById('voucher-class-dropdown').value = draft.voucherDiscount || '0'; 
                    document.getElementById('cod-checkbox').checked = draft.cod !== undefined ? draft.cod : true;
                    document.getElementById('promo-amo-checkbox').checked = draft.promoAmo !== undefined ? draft.promoAmo : true; // <-- PERUBAHAN 7E
                    document.getElementById('deal-khusus-checkbox').checked = draft.dealKhususAktif || false;
                    document.getElementById('deal-khusus-input').value = draft.dealKhususNominal || '';
                    const alokasiCheckbox = document.getElementById('voucher-alokasi-checkbox');
                    alokasiCheckbox.checked = draft.alokasiDiskon || false;
                    document.getElementById('fokus-alokasi-container').style.display = alokasiCheckbox.checked ? 'block' : 'none';
                    if (draft.fokusAlokasi) sessionStorage.setItem('draft_fokus_alokasi', JSON.stringify(draft.fokusAlokasi));
                } else { localStorage.removeItem(DRAFT_KEY); }
            }
            savedOrders = loadSavedOrders(); setViewMode(); renderProducts(true); 
            populateLoyaltyTable();
            populateVoucherClassDropdown(); 
            
            const draftFokus = sessionStorage.getItem('draft_fokus_alokasi');
            if(draftFokus) {
                const skusToCheck = JSON.parse(draftFokus);
                if (Array.isArray(skusToCheck)) { skusToCheck.forEach(sku => { const cb = document.querySelector(`.fokus-checkbox[value="${sku}"]`); if(cb) cb.checked = true; }); }
                sessionStorage.removeItem('draft_fokus_alokasi');
            }
            window.addEventListener('resize', setViewMode); calculateAll(false);
            const alokasiCheckbox = document.getElementById('voucher-alokasi-checkbox');
            alokasiCheckbox.addEventListener('input', () => {
                document.getElementById('fokus-alokasi-container').style.display = alokasiCheckbox.checked ? 'block' : 'none';
                calculateAll(false); saveDraft();
            });
            
            // const mainInputs = ['toko-name-input', 'voucher-class-dropdown', 'cod-checkbox', 'promo-amo-checkbox', 'deal-khusus-input', 'deal-khusus-checkbox'];
            mainInputs.forEach(id => {
                const element = document.getElementById(id);
                const eventType = (element.type === 'checkbox' || element.tagName.toLowerCase() === 'select') ? 'change' : 'input';
                element.addEventListener(eventType, () => { calculateAll(false); saveDraft(); });
            });
            
            const omzetInput = document.getElementById('monthly-omzet-input');
            omzetInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\./g, '');
                if (isNaN(value) || value === '') { e.target.value = ''; return; }
                const numberValue = parseInt(value, 10);
                e.target.value = numberValue.toLocaleString('id-ID');
            });

            window.scrollTo(0, 0);
        }
        window.onload = () => {
            // handleLogin akan dipanggil setelah login berhasil
        };
    </script>
</body>
</html>
